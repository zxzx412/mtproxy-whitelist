# HAProxy配置示例 - 支持PROXY Protocol传递真实IP
# 解决NAT环境下MTProxy白名单无法获取真实客户端IP的问题

global
    daemon
    maxconn 4096
    log stdout local0 info

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    log global

# 前端监听 - 接收客户端连接
frontend mtproxy_frontend
    bind *:443
    default_backend mtproxy_backend

# 后端服务 - 转发到MTProxy并发送PROXY Protocol头
backend mtproxy_backend
    # 发送PROXY Protocol v1头，包含真实客户端IP
    server mtproxy1 127.0.0.1:14202 send-proxy check

# Web管理界面代理
frontend web_frontend
    bind *:8989
    default_backend web_backend

backend web_backend
    # Web界面不需要PROXY Protocol
    server web1 127.0.0.1:8888 check

# 统计页面 (可选)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE